#!/bin/sh

arch=aarch64

if [ "$1" = "--print-arch" ]; then
	echo $arch
	exit
fi

echo "DEBUG: fake apk" "$@"

rootfs=.
kver=5.15.78-0
while [ $# -gt 0 ]; do
	case "$1" in
		add|del)
			cmd="$1"
			;;
		-p|--root)
			shift
			rootfs="$1"
			;;
		--arch) shift ;;
		--repositories-file) shift ;;
		--keys-dir) shift ;;
		[a-z]*)
			pkgs="$pkgs $1"
			;;
	esac
	shift
done

for pkg in $pkgs; do
	case "$pkg" in
		linux-firmware*)
			# simulate install firmware
			mkdir -p "$rootfs"/lib/firmware/brcm
			touch "$rootfs"/lib/firmware/brcm/brcmfmac43456-sdio.raspberrypi,400.bin \
				"$rootfs"/lib/firmware/brcm/brcmfmac43456-sdio.raspberrypi,400.clm_blob \
				"$rootfs"/lib/firmware/brcm/brcmfmac43456-sdio.raspberrypi,400.txt \
				"$rootfs"/lib/firmware/brcm/brcmfmac43752-sdio.bin
			;;
		linux-*)
			# simulate installing kernel
			flavor=${pkg#linux-}
			mkdir -p "$rootfs"/lib/modules/$kver-$flavor/kernel/drivers/net/wireless/broadcom/brcm80211/brcmfmac \
				"$rootfs"/boot
			touch "$rootfs"/boot/System.map-$flavor \
				"$rootfs"/boot/config-$flavor \
				"$rootfs"/boot/vmlinuz-$flavor
			cat >"$rootfs/lib/modules/$kver-$flavor"/kernel/drivers/net/wireless/broadcom/brcm80211/brcmfmac/brcmfmac.ko <<-EOF
				vermagic:       $kver-$flavor SMP preempt mod_unload modversions $arch
				firmware:       brcm/brcmfmac*-sdio.*.bin
				firmware:       brcm/brcmfmac*-sdio.*.txt
				firmware:       brcm/brcmfmac43752-sdio.clm_blob
				firmware:       brcm/brcmfmac43752-sdio.bin
			EOF
			gzip "$rootfs/lib/modules/$kver-$flavor"/kernel/drivers/net/wireless/broadcom/brcm80211/brcmfmac/brcmfmac.ko
			;;
	esac
done
